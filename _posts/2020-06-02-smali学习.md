---
title: as环境 gradle build 问题记录
description: 准备尝试安卓逆向，
categories:
 - 安卓
tags:
 - 安卓
 - 逆向
 - 转载
---

# Smali系列学习之smali函数调用语句分析

一.函数调用
smali中的函数和成员变量也分为两种，分别为 direct 和 virtual。两者的区别如下：

1.direct method 是指调用private方法。
2.virtual method 是指调用protected和public方法。
3.static method 是指调用static方法。
4.super method是指调用父类方法。
5.当然其实还有invoke-XXX/range指令的，这是参数多于4个的时候调用的指令，比较少见。

所以在调用函数时，有invoke-direct，invoke-virtual，另外还有invoke-static、invoke-super以及invoke-interface等几种不同的指令。

下面针对这几种函数调用的smali方法进行讲解。

1.invoke-static
用于调用static函数，例如：

``` smali
        invoke-static {}, Lcom/aaa;->CheckSignature()Z
```

注意：invoke-static后面有一对大括号“{}”，其实是调用该方法的实例+参数列表，由于这个方法既不需参数也是static的，所以{}内为空。

例如：

```
　　const-string v0, "NDKLIB"

　　invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V
```

　　这个是调用static void System.loadLibrary(String)来加载NDK编译的so库用的方法

2.invoke-super

调用父类方法用的指令，一般用于调用onCreate、onDestroy等方法。

3.invoke-direct

调用private函数：

例如：

```
　　invoke-direct {p0}, Landroid/app/TabActivity;-><init>()V
```

　　这里init()就是定义在TabActivity中的一个private函数。

4.invoke-virtual

用于调用protected或public函数，同样注意修改smali时不要错用invoke-direct或invoke-static。

5.invoke-xxxxx/range

当方法的参数多于5个时（含5个），不能直接使用以上的指令，而是在后面加上“/range”，range表示范围，使用方法也有所不同。


二.函数的返回结果

在Java代码中调用函数和返回函数结果可以用一条语句完成，而在Smali里则需要分开来完成，在使用上述指令后，如果调用的函数返回非void，那么还需要用到move-result（返回基本数据类型）和move-result-object（返回对象）指令：
```
　　const-string v0, "Eric"

　　invoke-static {v0}, Lcmb/pbi;->t(Ljava/lang/String;)Ljava/lang/String;

　　move-result-object  v2
```
上述中的v2寄存器保存的就是调用t方法返回的String字符串。

```
Toast.makeText(this, "Hello, Smali", Toast.LENGTH_LONG).show();

.line xx
const-string v0, "Hello, Smali"
const/4  v1, 0x1
invoke-static {p0, v0, v1}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object  v0
invoke-virtual {v0}, Landroid/widget/Toast;->show()V
```
>>> 转载于：https://www.cnblogs.com/eustoma/p/8989136.html

# Smali系列学习之Smali语法

一.smali的包中信息
```
.class  public Lcom/aaaaa;
.super  Lcom/bbbbb;
.source "ccccc.java"
```
1.它是com.aaaaa这个package下的类
2.继承自com.bbbbb
3.由ccccc.java编译得到的smali文件

二.smali中的声明

## annotations

```smali
.annotation system Ldalvik/annotation/MemberClasses;
　　value = {Lcom/aaa$qqq;,
　　　　　   Lcom/aaa$www;
　　　　　 }
.end annotation
```
这个声明是内部类的声明：aaa这个类它有两个成员内部类——qqq和www。

三.寄存器

本地寄存器用v开头数字结尾的符号来表示，如v0、v1、v2、...
参数寄存器则使用p开头数字结尾的符号来表示，如p0、p1、p2、...

注意：p0不一定是函数中的第一个参数，在非static函数中，p0代指“this”，p1表示函数的第一个参数，p2代表函数中的第二个参数…而在static函数中p0才对应第一个参数（因为Java的static方法中没有this方法。

简单分析：
```smali
const/4  v0, 0x1
iput-boolean  v0, p0, Lcom/aaa;->IsRegistered:Z
```
上面两句smali代码，首先使用本地v0寄存器，并将0x1存到v0中，然后第二句用iput-boolean这个指令把v0中的值存放到com.aaa.IsRegistered这个成员变量中。

相当于：this.IsRegistered=v0;

四.smali中的成员变量

成员变量格式是：
```smali
.field public/private [static] [final] varName:<类型>。
```
对于不同的成员变量也有不同的指令。

一般来说，
获取的指令有：iget、sget、iget-boolean、sget-boolean、iget-object、sget-object等。
操作的指令有：iput、sput、iput-boolean、sput-boolean、iput-object、sput-object等。

没有“-object”后缀的表示操作的成员变量对象是基本数据类型，带“-object”表示操作的成员变量是对象类型，特别地，boolean类型则使用带“-boolean”的指令操作。

五.Smali成员变量指令简析

1.sget-object v0, Lcom/aaa;->ID:Ljava/lang/String;
sget-object就是用来获取变量值并保存到紧接着的参数的寄存器中
本例中，它获取ID这个String类型的成员变量并放到v0这个寄存器中。
注意：前面需要该变量所属的类的类型，后面需要加一个冒号和该成员变量的类型，中间是“->”表示所属关系。

2.iget-object v0, p0, Lcom/aaa;->view:Lcom/aaa/view;
可以看到iget-object指令比sget-object多了一个参数，就是该变量所在类的实例，在这里就是p0即“this”。

3.sput指令的使用
```
const/4 v3, 0x0
sput-object v3, Lcom/aaa;->timer:Lcom/aaa/timer;
```
相当于：this.timer=null

4.iput指令的使用
```smali
.local v0, args:Landroid/os/Message;
const/4 v1, 0x12
iput v1, v0, Landroid/os/Message;->what:I
```
相当于：args.what = 18;

>>> 转载于：https://www.cnblogs.com/eustoma/p/8990449.html

# Smali系列学习之基础语法
一.什么是Smali？
Smali，Baksmali分别是指安卓系统里的Java虚拟机（Dalvik）所使用的一种dex格式文件的汇编器，反汇编器。其语法是一种宽松式的Jasmin/dedexer语法，而且它实现了.dex格式所有功能（注解，调试信息，线路信息等）

二.smali的语法
1.原始类型
B---byte
C---char
D---double
F---float
I---int
J---long
S---short
V---void
Z---boolean
[XXX---array
Lxxx/yyy---object

解析下最后两项，数组的表示方式是：

在基本类型前加上前中括号“[”，例如int数组和float数组分别表示为：[I、[F；
对象的表示则以L作为开头，格式LpackageName/objectName;（注意必须有个分号跟在最后），例如String对象在smali中为：Ljava/lang/String;，其中java/lang对应java.lang包，String就是定义在该包中的一个对象。

2.方法的定义
格式：Func-Name (Para-Type1Para-Type2Para-Type3...)Return-Type

注意：参数和参数间没有任何分隔符，

1.hello()v
　就是void hello()

2.hello(lll)Z
　就是boolean hello(int,int,int)

3.hello(Z[l[lLjava/lang/String;J)Ljava/lang/String
　就是String hello(boolean,int[],int[],String,long)

3.基本语法
.field private isFlag:z　定义变量
.method　　方法
.parameter　　方法参数
.prologue　　方法开始
.line 123　　此方法位于第123行
invoke-super　　调用父函数
const/high16 v0, 0x7fo3　　把0x7fo3赋值给v0
invoke-direct　　调用函数
return-void　　函数返回void
.end method　　函数结束
new-instance　　创建实例
iput-object　　对象赋值
iget-object　　调用对象
invoke-static　　调用静态函数

4.条件跳转分支：
"if-eq vA, vB, :cond_**" 如果vA等于vB则跳转到:cond_**
"if-ne vA, vB, :cond_**" 如果vA不等于vB则跳转到:cond_**
"if-lt vA, vB, :cond_**" 如果vA小于vB则跳转到:cond_**
"if-ge vA, vB, :cond_**" 如果vA大于等于vB则跳转到:cond_**
"if-gt vA, vB, :cond_**" 如果vA大于vB则跳转到:cond_**
"if-le vA, vB, :cond_**" 如果vA小于等于vB则跳转到:cond_**
"if-eqz vA, :cond_**" 如果vA等于0则跳转到:cond_**
"if-nez vA, :cond_**" 如果vA不等于0则跳转到:cond_**
"if-ltz vA, :cond_**" 如果vA小于0则跳转到:cond_**
"if-gez vA, :cond_**" 如果vA大于等于0则跳转到:cond_**
"if-gtz vA, :cond_**" 如果vA大于0则跳转到:cond_**
"if-lez vA, :cond_**" 如果vA小于等于0则跳转到:cond_**